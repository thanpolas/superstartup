#!/bin/sh
###
### Automatically push to production and staging installations
###

git-update-server-info

### Get current branch that was pushed
ref=$1

###
### SETTINGS AND PATHS
###

### Set branches that we will trigger on
live="refs/heads/master"
staging="refs/heads/next"

### Set paths here
masterRoot="/home/116255/users/.home/domains/"
livePath=masterRoot"superstartup.org"
stagingPath=masterRoot"staging.superstartup.org"
# set deployment preparation paths
deployPath=masterRoot"deploy-superstartup"
configLive=deployPath"/config/production"
configStaging=deployPath"/config/staging"
# Set path to CI's config folder
configPath="/engine/CI/origin/application/config"


# Set where CI's environment PHP file is (included by index.php)
# This file should be included in the .gitignore file to avoid
# merge conflicts. We overwrite this file on each push
envFile="/html/php/env.php"

# Set the location of the post-update script. git repo will ln -s to this
postUpdate="/engine/bin/git/post-update"

### Set string to echo on environment file depending on environment
envPHPmaster="<?php define('ENVIRONMENT', 'production'); ?>"
envPHPbeta="<?php define('ENVIRONMENT', 'staging'); ?>"

###
### SCRIPT STARTS HERE
###


### Check if we got 'beta' or 'master' branches pushed
### and update live installations

echo "*** Checking if pushed branch is next or master..."

if [ "$ref" = "$live" ]
then
  echo "*** master branch pushed. Deploying on LIVE site"


  #cd $masterPath
  #env -i git reset --hard
  ### Secure environment after the reset
  #echo $envPHPmaster > $masterPath$envFile

  #env -i git pull grid master
  ### Secure environment after the pull
  #echo $envPHPmaster > $masterPath$envFile

  ### Make post-update executable, git repo's hook is linked
  ### to this file
  #chmod a+x $masterPath$postUpdate
  
  ## init and update submodules
  #env -i git submodule init
  #env -i git submodule update
  
  
  randNum=$RANDOM
  echo "Random: "randNum
  echo "*** LIVE DEPLOYED-"

fi


###
### Go for the beta, checkout the git command to fit your own needs
###
if [ "$ref" = "$beta" ]
then
  echo "*** next branch pushed. Deploying on staging site"

  cd $betaPath
  env -i git reset --hard
  ### Secure environment after the reset
  echo $envPHPbeta > $betaPath$envFile

  env -i git pull grid beta
  ### Secure environment after the pull
  echo $envPHPbeta > $betaPath$envFile

  ### Make post-update executable, git repo's hook is linked
  ### to this file
  chmod a+x $betaPath$postUpdate

  echo "*** STAGING DEPLOYED"

fi

##

